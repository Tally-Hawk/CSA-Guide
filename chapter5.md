# مبانی ویندوز (Windows Fundamentals)

## **مقدمه‌ای بر ویندوز**

به عنوان یک متخصص تست نفوذ، تسلط بر طیف گسترده‌ای از نسخه‌های مختلف ویندوز ضروری است. اکثر سازمان‌ها از ویندوز و سیستم‌های لینوکس/یونیکس استفاده می‌کنند. بسیاری از سیستم‌ها هنوز از ویندوز قدیمی اجرا می‌شوند، در حالی که برخی دیگر به نسخه‌های ابری یا هیبریدی مهاجرت کرده‌اند. درک عملکرد داخلی ویندوز و نحوه تعامل سیستم‌های عملیاتی مختلف با یکدیگر، برای انجام تست نفوذ موفق حیاتی است.

## **سیستم عامل ویندوز**

مایکروسافت اولین نسخه سیستم عامل ویندوز را در نوامبر ۱۹۸۵ منتشر کرد. اولین نسخه ویندوز یک رابط گرافیکی (GUI) بود که بر روی MS-DOS اجرا می‌شد. نسخه Windows 95 اولین نسخه‌ای بود که به طور کامل مستقل از DOS بود. از آن زمان، ویندوز به یکی از محبوب‌ترین سیستم‌های عامل در جهان تبدیل شده است.

ویندوز ۱۱ جدیدترین نسخه است. مایکروسافت به طور مداوم نسخه‌های جدید ویندوز را منتشر می‌کند تا ویژگی‌های جدید، بهبودهای امنیتی و رفع باگ‌ها را ارائه دهد.

ویندوز در خانه‌ها، کسب‌وکارها و سرورها استفاده می‌شود. Windows Server نسخه مخصوص سرور ویندوز است که برای مدیریت شبکه، میزبانی وب و سایر وظایف سرور طراحی شده است.

## **نسخه‌های ویندوز**

جدول زیر برخی از نسخه‌های اصلی سیستم عامل ویندوز و شماره نسخه مربوطه را نشان می‌دهد:

| **نام سیستم عامل**          | **شماره نسخه** |
|------------------------------|-----------------|
| Windows NT 4                | 4.0            |
| Windows 2000                | 5.0            |
| Windows XP                  | 5.1            |
| Windows Server 2003 / 2003 R2 | 5.2          |
| Windows Vista / Server 2008 | 6.0            |
| Windows 7 / Server 2008 R2  | 6.1            |
| Windows 8 / Server 2012     | 6.2            |
| Windows 8.1 / Server 2012 R2| 6.3            |
| Windows 10 / Server 2016 / 2019 | 10.0       |

## **مفاهیم دسترسی به ویندوز**

### **دسترسی محلی (Local Access Concepts)**
- **دسترسی محلی** به معنای دسترسی فیزیکی به کامپیوتر است (مانند نشستن پشت میز، لپ‌تاپ و غیره).
- دسترسی محلی معمولاً قدرتمندترین نوع دسترسی است زیرا کنترل کامل بر روی کامپیوتر دارید.
- سازمان‌ها معمولاً سیاست‌های سخت‌گیرانه‌ای برای دسترسی محلی دارند تا از دسترسی غیرمجاز جلوگیری کنند.

### **دسترسی از راه دور (Remote Access Concepts)**
- **دسترسی از راه دور** به معنای دسترسی به کامپیوتر از یک مکان دیگر از طریق شبکه، اینترنت یا تکنولوژی‌های دیگر است.
- پروتکل‌های رایج دسترسی از راه دور عبارتند از:
  - **RDP** (Remote Desktop Protocol)
  - **SSH** (برای سیستم‌های لینوکس/یونیکس)
  - **VNC**
  - **Telnet** (کمتر امن)
  - **TeamViewer** یا **AnyDesk**

## **پروتکل دسکتاپ از راه دور (Remote Desktop Protocol - RDP)**

(آردی پی)RDP یک پروتکل اختصاصی مایکروسافت است که برای دسترسی از راه دور به کامپیوترهای ویندوزی استفاده می‌شود. این پروتکل به کاربران اجازه می‌دهد تا یک کامپیوتر ویندوزی را از راه دور کنترل کنند، انگار که پشت میز آن نشسته‌اند.

**ویژگی‌های کلیدی RDP:**
- رمزنگاری قوی ارتباطات
- پشتیبانی از انتقال فایل، کلیپ‌بورد و پرینتر
- امکان اتصال چندکاربره (در نسخه‌های سرور)

**نحوه استفاده از RDP:**
1. در ویندوز هدف، سرویس Remote Desktop را فعال کنید.
2. از ابزار **Remote Desktop Connection** در ویندوز استفاده کنید.
3. آدرس IP یا نام کامپیوتر هدف را وارد کنید.
4. نام کاربری و رمز عبور معتبر وارد کنید.

**نکات امنیتی مهم:**
- همیشه از رمزهای عبور قوی استفاده کنید.
- دسترسی RDP را فقط به IPهای مجاز محدود کنید.
- از Network Level Authentication (NLA) استفاده کنید.
- پورت پیش‌فرض RDP (3389) را تغییر دهید یا از VPN استفاده کنید.

# ساختار سیستم عامل (Operating System Structure)

در سیستم‌های عامل **ویندوز**، دایرکتوری ریشه (root directory) به صورت **<حرف درایو>:\** (معمولاً **C:**) است. این دایرکتوری که به عنوان **پارتیشن بوت** (boot partition) نیز شناخته می‌شود، محل نصب سیستم عامل است. درایوهای فیزیکی و مجازی دیگر با حروف دیگری مشخص می‌شوند، مثلاً Data (E:).

ساختار دایرکتوری‌های پارتیشن بوت به شرح زیر است:

### جدول دایرکتوری‌های اصلی در درایو C:

| **دایرکتوری**              | **عملکرد** |
|-----------------------------|-------------|
| **Perflogs**                | می‌تواند شامل لاگ‌های عملکرد ویندوز باشد که به طور پیش‌فرض ایجاد می‌شوند. |
| **Program Files**           | در سیستم‌های ۳۲ بیتی: تمام برنامه‌های ۱۶ و ۳۲ بیتی اینجا نصب می‌شوند.<br>در سیستم‌های ۶۴ بیتی: فقط برنامه‌های ۶۴ بیتی اینجا نصب می‌شوند. |
| **Program Files (x86)**     | در نسخه‌های ۶۴ بیتی ویندوز: برنامه‌های ۳۲ بیتی و ۱۶ بیتی اینجا نصب می‌شوند. |
| **ProgramData**             | پوشه مخفی که حاوی داده‌های ضروری برای اجرای برخی برنامه‌های نصب‌شده است. این داده‌ها برای برنامه بدون توجه به کاربر اجراکننده قابل دسترسی هستند. |
| **Users**                   | شامل پروفایل‌های کاربری برای هر کاربری که وارد سیستم می‌شود. این پوشه شامل دو زیرپوشه **Public** و **Default** است. |
| **Default**                 | الگوی پیش‌فرض پروفایل کاربری برای تمام کاربران جدید. هنگام ایجاد کاربر جدید، پروفایل از این الگو کپی می‌شود. |
| **Public**                  | پوشه‌ای برای اشتراک فایل‌ها بین کاربران کامپیوتر. به طور پیش‌فرض برای همه کاربران قابل دسترسی است و در شبکه نیز به اشتراک گذاشته می‌شود (نیاز به حساب شبکه معتبر دارد). |
| **AppData**                 | داده‌ها و تنظیمات برنامه‌ها برای هر کاربر در یک زیرپوشه مخفی (مثلاً C:\Users\<user>\AppData) ذخیره می‌شود. این پوشه شامل سه زیرپوشه است:<br>• **Roaming**: داده‌های مستقل از ماشین که باید همراه پروفایل کاربر باشد (مثل تنظیمات سفارشی).<br>• **Local**: تنظیمات خاص ماشین.<br>• **LocalLow**: مشابه Local اما با سطح یکپارچگی داده پایین‌تر (مثلاً برای مرورگر در حالت محافظت‌شده یا Safe Mode). |
| **Windows**                 | شامل اکثر فایل‌های مورد نیاز برای اجرای سیستم عامل ویندوز. |
| **System32 / SysWOW64**     | حاوی DLLهای سیستمی. System32 برای نسخه ۶۴ بیتی و SysWOW64 برای اجرای برنامه‌های ۳۲ بیتی در سیستم ۶۴ بیتی استفاده می‌شود. هنگام بارگذاری DLL بدون مسیر مطلق، سیستم عامل ابتدا این پوشه‌ها را جستجو می‌کند. |
| **WinSxS**                  | مخزن کامپوننت‌های ویندوز (Windows Component Store) که شامل کپی تمام کامپوننت‌ها، به‌روزرسانی‌ها و سرویس پک‌های ویندوز است. |

### کاوش دایرکتوری‌ها با استفاده از خط فرمان (Command Line)

- برای کاوش فایل‌سیستم می‌توان از دستور **dir** استفاده کرد.
- ابزار **tree** برای نمایش گرافیکی ساختار دایرکتوری یک مسیر یا دیسک بسیار مفید است.

**دستور مفید tree:**
```
tree C:\ /f | more
```
این دستور تمام فایل‌ها و پوشه‌های درایو C: را صفحه به صفحه نمایش می‌دهد. می‌توانید مسیر را به هر دایرکتوری دلخواه تغییر دهید.

# سیستم فایل

در سیستم‌عامل ویندوز مدرن، پنج نوع سیستم فایل وجود دارد: **FAT12**، **FAT16**، **FAT32**، **NTFS** و **exFAT**. امروزه از **FAT12** و **FAT16** دیگر استفاده نمی‌شود. در این آموزش، به‌طور مختصر به **FAT32** و **exFAT** اشاره می‌کنیم، اما تمرکز اصلی بر سیستم فایل **NTFS** خواهد بود.

### سیستم فایل FAT32

جدول تخصیص فایل **FAT32** در انواع مختلفی از دستگاه‌های ذخیره‌سازی مانند فلش مموری‌های USB و کارت‌های SD به‌طور گسترده استفاده می‌شود، اما می‌تواند برای فرمت کردن هارد دیسک‌ها نیز به‌کار رود. عدد «۳۲» در نام آن به این دلیل است که **FAT32** از ۳۲ بیت داده برای شناسایی خوشه‌های داده روی دستگاه ذخیره‌سازی استفاده می‌کند.

**مزایای FAT32:**

- سازگاری بالا با دستگاه‌ها: قابل استفاده در کامپیوترها، دوربین‌های دیجیتال، کنسول‌های بازی، گوشی‌های هوشمند، تبلت‌ها و غیره.
- سازگاری بین سیستم‌عامل‌ها: روی تمام نسخه‌های ویندوز از ویندوز ۹۵ به بعد کار می‌کند و همچنین توسط macOS و لینوکس پشتیبانی می‌شود.

**معایب FAT32:**

- حداکثر اندازه فایل مجاز تنها کمتر از ۴ گیگابایت است.
- فاقد ویژگی‌های داخلی حفاظت از داده یا فشرده‌سازی فایل.
- برای رمزنگاری فایل‌ها نیاز به ابزارهای شخص ثالث دارد.

### سیستم فایل NTFS (سیستم فایل فناوری جدید)

**(ان تی اف اس)NTFS** از زمان ویندوز NT 3.1 به‌عنوان سیستم فایل پیش‌فرض ویندوز بوده است. این سیستم فایل علاوه بر جبران کاستی‌های **FAT32**، پشتیبانی بهتری از متادیتا دارد و به‌دلیل ساختار بهبودیافته داده‌ها، عملکرد بهتری ارائه می‌دهد.

**مزایای NTFS:**

- قابلیت اطمینان بالا: در صورت خرابی سیستم یا قطع برق، می‌تواند یکپارچگی سیستم فایل را بازیابی کند.
- امکان تنظیم مجوزهای دقیق و جزئی روی فایل‌ها و پوشه‌ها برای امنیت بیشتر.
- پشتیبانی از پارتیشن‌های بسیار بزرگ.
- دارای قابلیت ژورنالینگ داخلی: تمام تغییرات فایل (افزودن، ویرایش، حذف) ثبت می‌شوند.

**معایب NTFS:**

- بیشتر دستگاه‌های موبایل به‌طور پیش‌فرض از NTFS پشتیبانی نمی‌کنند.
- دستگاه‌های رسانه‌ای قدیمی مانند تلویزیون‌ها و دوربین‌های دیجیتال معمولاً از دستگاه‌های ذخیره‌سازی NTFS پشتیبانی نمی‌کنند.

### مجوزها (Permissions)

سیستم فایل **NTFS** دارای مجوزهای پایه و پیشرفته متعددی است. برخی از انواع مهم مجوزها عبارتند از:

| **نوع مجوز**              | **توضیحات**                                                                 |
|----------------------------|-----------------------------------------------------------------------------|
| کنترل کامل (Full Control)   | امکان خواندن، نوشتن، تغییر و حذف فایل‌ها/پوشه‌ها.                         |
| تغییر (Modify)             | امکان خواندن، نوشتن و حذف فایل‌ها/پوشه‌ها.                                 |
| مشاهده محتویات پوشه (List Folder Contents) | امکان مشاهده و لیست کردن پوشه‌ها و زیرپوشه‌ها و همچنین اجرای فایل‌ها (فقط برای پوشه‌ها ارث‌بری می‌شود). |
| خواندن و اجرا (Read and Execute) | امکان خواندن و لیست کردن فایل‌ها و زیرپوشه‌ها و اجرای فایل‌ها (برای فایل‌ها و پوشه‌ها ارث‌بری می‌شود). |
| نوشتن (Write)              | امکان افزودن فایل به پوشه‌ها و زیرپوشه‌ها و نوشتن در فایل.                 |
| خواندن (Read)              | امکان مشاهده و لیست کردن پوشه‌ها و زیرپوشه‌ها و مشاهده محتوای فایل.        |
| عبور از پوشه (Traverse Folder) | امکان عبور از پوشه‌ها برای دسترسی به فایل‌ها یا پوشه‌های دیگر، حتی اگر مجوز لیست کردن محتویات وجود نداشته باشد. |

فایل‌ها و پوشه‌ها به‌طور پیش‌فرض مجوزهای **NTFS** را از پوشه والد خود به ارث می‌برند تا مدیریت ساده‌تر شود. در صورتی که نیاز به تنظیم مجوزهای خاص باشد، مدیر می‌تواند ارث‌بری مجوزها را غیرفعال کند و مجوزها را به‌طور مستقیم تنظیم نماید.

### لیست کنترل دسترسی یکپارچگی (icacls)

مجوزهای **NTFS** روی فایل‌ها و پوشه‌ها در ویندوز را می‌توان از طریق رابط گرافیکی File Explorer (تب Security) مدیریت کرد. همچنین از خط فرمان با ابزار **icacls** می‌توان کنترل بسیار دقیق‌تری اعمال کرد.

برای مشاهده مجوزهای یک پوشه می‌توان از دستور **icacls** در پوشه جاری یا **icacls c:\Windows** برای پوشه‌ای خاص استفاده کرد.

**نمونه خروجی:**

```
NT SERVICE\TrustedInstaller:(F)
BUILTIN\Administrators:(OI)(CI)(F)
NT AUTHORITY\SYSTEM:(OI)(CI)(F)
BUILTIN\Users:(OI)(CI)(RX)
...
```

**تنظیمات ارث‌بری ممکن:**

- **(OI)**: ارث‌بری برای اشیاء
- **(CI)**: ارث‌بری برای کانتینرها
- **(IO)**: فقط ارث‌بری (بدون اعمال مستقیم)
- **(NP)**: عدم انتشار ارث‌بری
- **(I)**: مجوز ارث‌بری‌شده از والد

**مجوزهای پایه:**

- **F**: دسترسی کامل
- **M**: دسترسی تغییر
- **RX**: خواندن و اجرا
- **R**: فقط خواندن
- **W**: فقط نوشتن
- **D**: حذف

برای افزودن مجوز می‌توان از دستور زیر استفاده کرد:

**icacls c:\Users /grant joe:F**

این دستور به کاربر **joe** دسترسی کامل می‌دهد، اما چون **(OI)** و **(CI)** مشخص نشده، فقط روی پوشه اصلی اعمال می‌شود و به زیرپوشه‌ها ارث‌بری نمی‌شود.

برای حذف مجوز:

**icacls c:\Users /remove joe**

ابزار **icacls** بسیار قدرتمند است و می‌تواند در محیط دامنه برای اعطای مجوزهای خاص به کاربران یا گروه‌ها، انکار صریح دسترسی، فعال/غیرفعال کردن ارث‌بری و تغییر مالکیت استفاده شود.

## **مجوزهای NTFS در مقابل مجوزهای اشتراک‌گذاری**

**مقدمه**  
در ویندوز، برای کنترل دسترسی به فایل‌ها و پوشه‌ها از دو نوع مجوز استفاده می‌شود: مجوزهای NTFS و مجوزهای اشتراک‌گذاری (Share Permissions). این دو نوع مجوز به‌طور مستقل عمل می‌کنند و هنگام دسترسی به منابع از طریق شبکه، مجوز مؤثر، محدودترین ترکیب این دو خواهد بود.

**تفاوت مجوزهای اشتراک‌گذاری و NTFS**

- **مجوزهای اشتراک‌گذاری (Share Permissions):**  
  تنها زمانی اعمال می‌شوند که کاربر از طریق شبکه به پوشه اشتراک‌گذاری‌شده دسترسی پیدا کند.  
  این مجوزها روی کل پوشه اشتراک‌گذاری‌شده اعمال می‌شوند و نمی‌توان آن‌ها را برای زیرپوشه‌ها یا فایل‌های خاص تنظیم کرد.  
  سه سطح مجوز وجود دارد:  
  - **کنترل کامل (Full Control)**  
  - **تغییر (Change)**  
  - **خواندن (Read)**

- **مجوزهای NTFS:**  
  هنگام دسترسی محلی یا از راه دور (شبکه) اعمال می‌شوند.  
  امکان تنظیم دقیق‌تر برای فایل‌ها و زیرپوشه‌ها وجود دارد.  
  سطوح مجوز متنوع‌تری دارد از جمله:  
  - کنترل کامل  
  - تغییر  
  - خواندن و اجرا  
  - خواندن  
  - نوشتن  
  - مجوزهای ویژه (Special Permissions)

**ترکیب مجوزها**  
هنگام دسترسی از طریق شبکه، مجوز مؤثر برابر با محدودترین مجوز بین مجوزهای اشتراک‌گذاری و مجوزهای NTFS است.

**ایجاد اشتراک‌گذاری شبکه (Network Share)**

**مراحل ایجاد پوشه اشتراک‌گذاری‌شده:**

1. روی پوشه موردنظر راست‌کلیک کنید و **Properties** را انتخاب کنید.  
2. به تب **Sharing** بروید.  
3. روی دکمه **Share** کلیک کنید.  
4. کاربران یا گروه‌هایی که می‌خواهید دسترسی بدهید را اضافه کنید.  
5. سطح مجوز اشتراک‌گذاری (Read، Change یا Full Control) را برای هر کدام تعیین کنید.  
6. روی **Share** و سپس **Done** کلیک کنید.

**تنظیم مجوزهای پیشرفته NTFS**

1. در پنجره Properties پوشه، به تب **Security** بروید.  
2. روی **Edit** کلیک کنید تا مجوزها را تغییر دهید.  
3. کاربران یا گروه‌ها را اضافه یا حذف کنید.  
4. برای تنظیم مجوزهای دقیق‌تر، روی **Advanced** کلیک کنید.

**نکات مهم در استفاده از فایروال ویندوز دیفندر**

- پورت‌های مورد نیاز برای اشتراک‌گذاری فایل (File and Printer Sharing) باید باز باشند.  
- در محیط‌های دامنه‌ای، بهتر است از سیاست‌های گروهی (Group Policy) برای مدیریت قوانین فایروال استفاده شود.

**نمایش اشتراک‌های موجود**

- از Computer Management → Shared Folders → Shares می‌توانید لیست تمام اشتراک‌ها را ببینید.

**نظارت بر دسترسی‌ها در Event Viewer**

- رویدادهای مربوط به دسترسی به فایل‌ها را می‌توان در بخش Security logs مشاهده کرد.

**سؤالات متداول**

- **تفاوت اصلی بین NTFS و Share Permissions چیست؟**  
  مجوزهای اشتراک‌گذاری فقط از راه شبکه اعمال می‌شوند، اما مجوزهای NTFS هم محلی و هم از راه دور مؤثر هستند.

- **کدام مجوز محدودکننده‌تر است؟**  
  هنگام دسترسی شبکه‌ای، محدودترین ترکیب هر دو نوع مجوز اعمال می‌شود.

# خدمات و فرآیندهای ویندوز (Windows Services & Processes)

## خدمات ویندوز (Windows Services)

خدمات یکی از اجزای اصلی سیستم‌عامل ویندوز هستند. این خدمات امکان ایجاد و مدیریت برنامه‌های طولانی‌مدت را فراهم می‌کنند که در پس‌زمینه اجرا می‌شوند، حتی زمانی که هیچ کاربری وارد سیستم نشده باشد یا پس از خروج کاربر همچنان فعال بمانند.

**ویژگی‌های کلیدی خدمات ویندوز:**
- امکان تبدیل برنامه‌های عادی به سرویس
- مسئول انجام وظایف مهم سیستم مانند شبکه، تشخیص خطا، مدیریت اعتبار کاربران، به‌روزرسانی ویندوز و غیره
- مدیریت توسط **مدیر کنترل سرویس (Service Control Manager - SCM)** انجام می‌شود
- ابزار گرافیکی مدیریت: کنسول **services.msc**
- مدیریت از طریق خط فرمان با دستور **sc.exe** یا **PowerShell** (مانند Get-Service، Stop-Service و ...)

**وضعیت‌های ممکن یک سرویس:**
- در حال اجرا (Running)
- متوقف شده (Stopped)
- در حالت توقف موقت (Paused)
- در حال شروع (Starting)
- در حال توقف (Stopping)

**انواع راه‌اندازی (Startup Type):**
- خودکار (Automatic)
- خودکار با تأخیر (Automatic - Delayed Start)
- دستی (Manual)
- غیرفعال (Disabled)

**دسته‌بندی حساب‌های اجرایی خدمات:**
- Local System
- Local Service
- Network Service
- حساب کاربری خاص

**خدمات بسیار مهم و غیرقابل توقف (حیاتی):**
این خدمات معمولاً با امتیاز بالا اجرا می‌شوند و توقف آن‌ها می‌تواند منجر به کرش سیستم یا نیاز به ری‌استارت شود.

| نام سرویس (معروف)       | توضیحات                                                                                   |
|--------------------------|-------------------------------------------------------------------------------------------|
| **smss.exe**             | زیرسیستم مدیریت جلسه (Session Manager Subsystem) – مسئول مدیریت جلسات کاربری               |
| **csrss.exe**            | زیرسیستم سمت کاربر ویندوز (Client Server Runtime Process)                                 |
| **winlogon.exe**         | مدیریت ورود کاربران به سیستم                                                              |
| **lsass.exe**            | سرور احراز هویت امنیتی محلی (Local Security Authority Subsystem Service) – احراز هویت کاربران |
| **services.exe**         | مدیر کنترل سرویس (Service Control Manager) – قلب مدیریت تمام خدمات                         |
| **svchost.exe**          | میزبان چندین سرویس ویندوزی (معمولاً چندین نمونه از آن در حال اجراست)                     |
| **spoolsv.exe**          | مدیریت صف چاپ (Print Spooler)                                                            |
| **wuauserv**             | سرویس به‌روزرسانی ویندوز (Windows Update)                                               |

**نکته امنیتی مهم:**  
برخی خدمات ممتاز (privileged services) می‌توانند به عنوان بردار ارتقای امتیاز (privilege escalation vector) مورد سوءاستفاده قرار گیرند، به‌خصوص اگر تنظیمات نادرستی داشته باشند یا فایل‌های اجرایی آن‌ها قابل نوشتن توسط کاربر معمولی باشد.

## فرآیندها (Processes) در ویندوز

فرآیندها برنامه‌هایی هستند که در حال اجرا در سیستم می‌باشند. هر برنامه، سرویس یا وظیفه سیستمی یک یا چند فرآیند ایجاد می‌کند.

**ابزارهای مهم مشاهده و مدیریت فرآیندها:**
- **Task Manager** (taskmgr.exe) → نمای گرافیکی ساده
- **Process Explorer** (از مجموعه Sysinternals) → پیشرفته‌ترین ابزار
- **Tasklist** و **Taskkill** → خط فرمان
- **Get-Process** و **Stop-Process** → PowerShell
- **Resource Monitor** (resmon.exe)
- **Sysinternals Process Monitor** (ProcMon)

**فرآیندهای سیستمی مهم که معمولاً همیشه فعال هستند:**
- **smss.exe** – اولین فرآیند کاربرسپاری شده بعد از بوت
- **csrss.exe** – ضروری برای رابط گرافیکی
- **wininit.exe** – شروع‌کننده خدمات و lsass، services و غیره
- **lsass.exe** – احراز هویت و سیاست‌های امنیتی
- **svchost.exe** – میزبان صدها سرویس مختلف
- **dwm.exe** – مدیر پنجره‌ها (Desktop Window Manager)
- **explorer.exe** – پوسته ویندوز (فایل اکسپلورر و دسکتاپ)

**نکته:** توقف دستی برخی از این فرآیندها (مانند csrss.exe یا lsass.exe) باعث صفحه آبی مرگ (BSOD) می‌شود.

## ابزارهای پیشنهادی Sysinternals (مایکروسافت)

- **Process Explorer** → بهترین جایگزین Task Manager
- **Process Monitor** → مشاهده تمام فعالیت‌های فایل، رجیستری و شبکه فرآیندها
- **Autoruns** → مشاهده تمام برنامه‌هایی که به‌صورت خودکار اجرا می‌شوند
- **TCPView** → مشاهده اتصالات شبکه فعال

این ابزارها رایگان و بسیار قدرتمند هستند و در حوزه امنیت، عیب‌یابی و هک اخلاقی بسیار مورد استفاده قرار می‌گیرند.

**خلاصه نکات مهم برای آزمون‌ها و محیط‌های عملیاتی:**
- خدمات حیاتی را هرگز بدون دلیل متوقف نکنید.
- برای تغییر تنظیمات سرویس‌ها از **services.msc** یا **sc config** استفاده کنید.
- برای مشاهده و خاتمه فرآیندها در محیط‌های محدود، از **Task Manager** یا **psexec -s taskmgr** استفاده کنید.
- فرآیند **svchost.exe** همیشه چندین نمونه دارد؛ برای تشخیص سرویس داخل آن از **Tasklist /svc** یا Process Explorer استفاده کنید.


# **مجوزهای سرویس‌ها (Service Permissions)**

سرویس‌ها امکان مدیریت فرآیندهای طولانی‌مدت را فراهم می‌کنند و بخش حیاتی سیستم‌عامل ویندوز به شمار می‌روند. اغلب سیستم‌ها این سرویس‌ها را به عنوان بردارهای تهدید نادیده می‌گیرند، در حالی که می‌توانند برای بارگذاری DLLهای مخرب، اجرای برنامه‌ها بدون دسترسی ادمین، ارتقای سطح دسترسی و حتی ماندگاری (Persistence) مورد سوءاستفاده قرار گیرند. این بردارهای تهدید معمولاً به دلیل **پیکربندی نادرست مجوزهای سرویس** توسط نرم‌افزارهای شخص ثالث یا اشتباهات مدیران در حین نصب ایجاد می‌شوند.

## **چرا باید به مجوزهای سرویس توجه کنیم؟**

اولین قدم، درک وجود این مجوزها و توجه به آن‌ها هنگام مدیریت سیستم است. باید به این فکر کنیم که یک سرویس چگونه می‌تواند:

- سطح دسترسی را ارتقا دهد  
- به سیستم‌های نصب‌شده متصل شود  
- بدافزار اجرا کند  
- کد مخرب را از طرف ما اجرا نماید  

**مثال واقعی:**  
اگر هنگام نصب DHCP به عنوان کاربر «باب» وارد سیستم شده باشیم، سرویس به‌صورت پیش‌فرض با حساب باب اجرا می‌شود (مگر اینکه مشخصاً تغییر داده شود). اگر باب از شرکت اخراج شود و حسابش غیرفعال گردد، سرویس DHCP هم متوقف می‌شود و کل شبکه بدون آدرس IP می‌ماند!  
**راه‌حل پیشنهادی:** برای سرویس‌های حیاتی شبکه، از **حساب‌های سرویس اختصاصی (Service Accounts)** استفاده کنید.

همچنین باید به **مجوزهای NTFS پوشه‌ای که سرویس از آن اجرا می‌شود** توجه ویژه داشت؛ زیرا در صورت ضعیف بودن مجوزها، مهاجم می‌تواند فایل اجرایی اصلی را با یک فایل مخرب جایگزین کند.

## **بررسی سرویس‌ها با ابزار services.msc**

با اجرای `services.msc` می‌توان تمام جزئیات سرویس‌ها را مشاهده و تنظیم کرد. به موارد زیر توجه کنید:

- **نام سرویس (Service Name):** برای استفاده در خط فرمان ضروری است  
- **مسیر اجرایی (Path to executable):** اگر مجوزهای NTFS پوشه ضعیف باشد، قابل جایگزینی با فایل مخرب است  
- **حساب اجرا (Log On As):** بسیاری از سرویس‌ها به‌صورت پیش‌فرض با **LocalSystem** (بالاترین سطح دسترسی) اجرا می‌شوند  
- **تب Recovery:** امکان اجرای برنامه دلخواه در صورت شکست سرویس → بردار خطرناک برای مهاجمان

### **حساب‌های سرویس داخلی مهم ویندوز**
- **LocalService**  
- **NetworkService**  
- **LocalSystem** (بالاترین سطح دسترسی)

**توصیه امنیتی:** همیشه از اصل **حداقل دسترسی ممکن (Principle of Least Privilege)** پیروی کنید.

## **بررسی سرویس‌ها با دستور sc**

دستور `sc` ابزار قدرتمندی برای مدیریت سرویس‌ها از خط فرمان است:

```cmd
sc qc wuauserv          → نمایش تنظیمات سرویس
sc qdescription wuauserv → نمایش توضیحات
sc start wuauserv       → شروع سرویس
sc stop wuauserv        → توقف سرویس
```

برای اجرای این دستورات معمولاً نیاز به **دسترسی ادمین** است.

## **بررسی مجوزهای سرویس با sc و SDDL**

برای مشاهده مجوزهای دقیق سرویس از دستور زیر استفاده می‌شود:

```cmd
sc sdshow wuauserv
```

خروجی به صورت **SDDL (Security Descriptor Definition Language)** است. تفسیر بخشی از آن:

- **D:** → نشان‌دهنده DACL (لیست کنترل دسترسی اختیاری)  
- **AU:** → کاربران تأییدشده (Authenticated Users)  
- **A:** → دسترسی مجاز است  
- **CC** → SERVICE_QUERY_CONFIG  
- **LC** → SERVICE_QUERY_STATUS  
- **SW** → SERVICE_START  
- **RP** → SERVICE_START  
- **LO** → SERVICE_INTERROGATE  
- **RC** → READ_CONTROL

هر مجموعه کاراکترها بین نقطه‌ویرگول‌ها نشان‌دهنده مجوزهای اعطا شده به یک گروه یا کاربر خاص است.

## **بررسی مجوزهای سرویس با PowerShell**

```powershell
Get-Acl -Path "HKLM:\SYSTEM\CurrentControlSet\Services\wuauserv" | Format-List
```

این دستور خروجی خواناتری ارائه می‌دهد و شامل **SID** هر حساب نیز می‌شود.

## **جمع‌بندی و توصیه‌های امنیتی**

- همیشه برای سرویس‌های حیاتی از **حساب سرویس اختصاصی** استفاده کنید  
- مجوزهای NTFS پوشه‌های اجرایی سرویس‌ها را بررسی و محدود کنید  
- از اصل **حداقل دسترسی ممکن** پیروی کنید  
- تب Recovery سرویس‌ها را بررسی کنید (ممکن است راه اجرای کد مخرب باشد)  
- از ابزارهای خط فرمان (sc، PowerShell) برای اسکریپت‌نویسی و بررسی سریع در محیط‌های بزرگ استفاده کنید  
- SDDL سرویس‌های حساس (مانند Windows Update، Print Spooler و ...) را به‌صورت دوره‌ای بررسی کنید

**توجه:** پیکربندی نادرست یک سرویس می‌تواند منجر به توقف خدمات شبکه، ارتقای دسترسی یا ماندگاری دائمی مهاجم شود. مجوزهای سرویس یکی از مهم‌ترین بخش‌های نادیده‌گرفته‌شده در امنیت ویندوز است.
